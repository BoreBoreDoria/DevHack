/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/lazy.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, EventEmitter, InjectionToken, Injector, Input, NgModuleFactoryLoader, Output, TemplateRef, ViewContainerRef } from '@angular/core';
import { from } from 'rxjs';
import { catchError, finalize, tap } from 'rxjs/operators';
/**
 * @record
 */
function LazyContext() { }
if (false) {
    /** @type {?} */
    LazyContext.prototype.$implicit;
}
/** @type {?} */
export var LAZY_COMPONENT_TOKEN = new InjectionToken('Lazy Component Token');
var LazyDirective = /** @class */ (function () {
    function LazyDirective(templateRef, viewContainer, loader, injector) {
        this.templateRef = templateRef;
        this.viewContainer = viewContainer;
        this.loader = loader;
        this.injector = injector;
        this.activate = new EventEmitter();
        this.deactivate = new EventEmitter();
        this.context = {
            $implicit: null
        };
        this.embeddedViewRef = this.templateRef.createEmbeddedView(this.context);
    }
    Object.defineProperty(LazyDirective.prototype, "component", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            if (this.componentRef) {
                return this.componentRef.instance;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LazyDirective.prototype, "projectableNodes", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return [this.templateRef.createEmbeddedView(this.context).rootNodes];
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} changes
     * @return {?}
     */
    LazyDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if ('lazy' in changes) {
            this.onLazyDidChanged(this.lazy, changes.lazy.previousValue);
        }
        if ('lazyLoadChildren' in changes) {
            this.onLazyDidChanged(this.lazyLoadChildren, changes.lazyLoadChildren.previousValue);
        }
    };
    /**
     * @return {?}
     */
    LazyDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.dispose();
        if (this.embeddedViewRef) {
            this.embeddedViewRef.destroy();
            this.embeddedViewRef = null;
        }
    };
    /**
     * @private
     * @param {?} current
     * @param {?} previous
     * @return {?}
     */
    LazyDirective.prototype.onLazyDidChanged = /**
     * @private
     * @param {?} current
     * @param {?} previous
     * @return {?}
     */
    function (current, previous) {
        if (!this.ngModuleRef) {
            return current && this.loadAndRender(current);
        }
        if (current !== previous) {
            this.dispose();
            return this.onLazyDidChanged(current, null);
        }
    };
    /**
     * @private
     * @param {?} path
     * @return {?}
     */
    LazyDirective.prototype.loadAndRender = /**
     * @private
     * @param {?} path
     * @return {?}
     */
    function (path) {
        var _this = this;
        this.subscription = this.load(path).pipe(tap((/**
         * @param {?} ngModuleFactory
         * @return {?}
         */
        function (ngModuleFactory) {
            _this.ngModuleRef = ngModuleFactory.create(_this.injector);
            /** @type {?} */
            var component = _this.ngModuleRef.injector.get(LAZY_COMPONENT_TOKEN);
            /** @type {?} */
            var componentFactory = _this.ngModuleRef.componentFactoryResolver.resolveComponentFactory(component);
            _this.componentRef = _this.viewContainer.createComponent(componentFactory, _this.viewContainer.length, _this.injector, _this.projectableNodes, _this.ngModuleRef);
        })), finalize((/**
         * @return {?}
         */
        function () { return _this.onActivate(_this.component); }))).subscribe();
    };
    /**
     * @private
     * @param {?} path
     * @return {?}
     */
    LazyDirective.prototype.load = /**
     * @private
     * @param {?} path
     * @return {?}
     */
    function (path) {
        var _this = this;
        /** @type {?} */
        var pathProduction = path.split('#').join('.ts#');
        return from(this.loader.load(pathProduction)).pipe(catchError((/**
         * @return {?}
         */
        function () { return from(_this.loader.load(path)); })));
    };
    /**
     * @private
     * @param {?} component
     * @return {?}
     */
    LazyDirective.prototype.onActivate = /**
     * @private
     * @param {?} component
     * @return {?}
     */
    function (component) {
        this.activate.emit(component);
        if (isFunction(this.lazyActivate)) {
            this.lazyActivate(component);
        }
        this.context.$implicit = component;
        this.embeddedViewRef.markForCheck();
    };
    /**
     * @private
     * @param {?} component
     * @return {?}
     */
    LazyDirective.prototype.onDeactivate = /**
     * @private
     * @param {?} component
     * @return {?}
     */
    function (component) {
        this.deactivate.emit(component);
        if (isFunction(this.lazyDeactivate)) {
            this.lazyDeactivate(component);
        }
        this.context.$implicit = null;
        this.embeddedViewRef.markForCheck();
    };
    /**
     * @private
     * @return {?}
     */
    LazyDirective.prototype.dispose = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.componentRef) {
            /** @type {?} */
            var c = this.component;
            this.componentRef.destroy();
            this.componentRef = null;
            this.onDeactivate(c);
        }
        if (this.ngModuleRef) {
            this.ngModuleRef.destroy();
            this.ngModuleRef = null;
        }
        if (this.subscription) {
            this.subscription.unsubscribe();
            this.subscription = null;
        }
    };
    LazyDirective.decorators = [
        { type: Directive, args: [{ selector: '[lazy]' },] }
    ];
    /** @nocollapse */
    LazyDirective.ctorParameters = function () { return [
        { type: TemplateRef },
        { type: ViewContainerRef },
        { type: NgModuleFactoryLoader },
        { type: Injector }
    ]; };
    LazyDirective.propDecorators = {
        lazy: [{ type: Input }],
        lazyLoadChildren: [{ type: Input }],
        lazyActivate: [{ type: Input }],
        lazyDeactivate: [{ type: Input }],
        activate: [{ type: Output }],
        deactivate: [{ type: Output }]
    };
    return LazyDirective;
}());
export { LazyDirective };
if (false) {
    /** @type {?} */
    LazyDirective.prototype.lazy;
    /** @type {?} */
    LazyDirective.prototype.lazyLoadChildren;
    /** @type {?} */
    LazyDirective.prototype.lazyActivate;
    /** @type {?} */
    LazyDirective.prototype.lazyDeactivate;
    /** @type {?} */
    LazyDirective.prototype.activate;
    /** @type {?} */
    LazyDirective.prototype.deactivate;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.context;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.componentRef;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.embeddedViewRef;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.ngModuleRef;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.templateRef;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.viewContainer;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.loader;
    /**
     * @type {?}
     * @private
     */
    LazyDirective.prototype.injector;
}
/**
 * @param {?} value
 * @return {?}
 */
function isFunction(value) {
    return typeof value === 'function';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4Zi9wbGF0Zm9ybS8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2xhenkuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUdMLFNBQVMsRUFFVCxZQUFZLEVBQ1osY0FBYyxFQUNkLFFBQVEsRUFDUixLQUFLLEVBRUwscUJBQXFCLEVBSXJCLE1BQU0sRUFFTixXQUFXLEVBRVgsZ0JBQWdCLEVBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxJQUFJLEVBQWdDLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRTNELDBCQUVDOzs7SUFEQyxnQ0FBZTs7O0FBR2pCLE1BQU0sS0FBTyxvQkFBb0IsR0FBRyxJQUFJLGNBQWMsQ0FBWSxzQkFBc0IsQ0FBQztBQUV6RjtJQWlDRSx1QkFDVSxXQUFxQyxFQUNyQyxhQUErQixFQUMvQixNQUE2QixFQUM3QixRQUFrQjtRQUhsQixnQkFBVyxHQUFYLFdBQVcsQ0FBMEI7UUFDckMsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQy9CLFdBQU0sR0FBTixNQUFNLENBQXVCO1FBQzdCLGFBQVEsR0FBUixRQUFRLENBQVU7UUE3QmxCLGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUN0RCxlQUFVLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFMUQsWUFBTyxHQUFnQjtZQUM3QixTQUFTLEVBQUUsSUFBSTtTQUNoQixDQUFDO1FBY00sb0JBQWUsR0FDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFVakQsQ0FBQztJQXZCSixzQkFBWSxvQ0FBUzs7Ozs7UUFBckI7WUFDRSxJQUFJLElBQUksQ0FBQyxZQUFZLEVB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SSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDekI7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUMxQjtJQUNILENBQUM7O2dCQWxJRixTQUFTLFNBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFOzs7O2dCQWIvQixXQUFXO2dCQUVYLGdCQUFnQjtnQkFSaEIscUJBQXFCO2dCQUhyQixRQUFROzs7dUJBeUJQLEtBQUs7bUNBQ0wsS0FBSzsrQkFDTCxLQUFLO2lDQUNMLEtBQUs7MkJBRUwsTUFBTTs2QkFDTixNQUFNOztJQTJIVCxvQkFBQztDQUFBLEFBcElELElBb0lDO1NBbklZLGFBQWE7OztJQUV4Qiw2QkFBc0I7O0lBQ3RCLHlDQUFrQzs7SUFDbEMscUNBQWdEOztJQUNoRCx1Q0FBa0Q7O0lBRWxELGlDQUFnRTs7SUFDaEUsbUNBQWtFOzs7OztJQUVsRSxnQ0FFRTs7Ozs7SUFRRixxQ0FBd0M7Ozs7O0lBTXhDLHdDQUNvRDs7Ozs7SUFFcEQscUNBQXVDOzs7OztJQUN2QyxvQ0FBc0M7Ozs7O0lBR3BDLG9DQUE2Qzs7Ozs7SUFDN0Msc0NBQXVDOzs7OztJQUN2QywrQkFBcUM7Ozs7O0lBQ3JDLGlDQUEwQjs7Ozs7O0FBaUc5QixTQUFTLFVBQVUsQ0FBQyxLQUFVO0lBQzVCLE9BQU8sT0FBTyxLQUFLLEtBQUssVUFBVSxDQUFDO0FBQ3JDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5LFxuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdGlvblRva2VuLFxuICBJbmplY3RvcixcbiAgSW5wdXQsXG4gIE5nTW9kdWxlRmFjdG9yeSxcbiAgTmdNb2R1bGVGYWN0b3J5TG9hZGVyLFxuICBOZ01vZHVsZVJlZixcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsXG4gIFR5cGUsXG4gIFZpZXdDb250YWluZXJSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb25MaWtlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaW5hbGl6ZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbnRlcmZhY2UgTGF6eUNvbnRleHQge1xuICAkaW1wbGljaXQ6IGFueTtcbn1cblxuZXhwb3J0IGNvbnN0IExBWllfQ09NUE9ORU5UX1RPS0VOID0gbmV3IEluamVjdGlvblRva2VuPFR5cGU8YW55Pj4oJ0xhenkgQ29tcG9uZW50IFRva2VuJyk7XG5cbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tsYXp5XScgfSlcbmV4cG9ydCBjbGFzcyBMYXp5RGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpIGxhenk6IHN0cmluZztcbiAgQElucHV0KCkgbGF6eUxvYWRDaGlsZHJlbjogc3RyaW5nO1xuICBASW5wdXQoKSBsYXp5QWN0aXZhdGU6IChjb21wb25lbnQ6IGFueSkgPT4gdm9pZDtcbiAgQElucHV0KCkgbGF6eURlYWN0aXZhdGU6IChjb21wb25lbnQ6IGFueSkgPT4gdm9pZDtcblxuICBAT3V0cHV0KCkgYWN0aXZhdGU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBkZWFjdGl2YXRlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHByaXZhdGUgY29udGV4dDogTGF6eUNvbnRleHQgPSB7XG4gICAgJGltcGxpY2l0OiBudWxsXG4gIH07XG5cbiAgcHJpdmF0ZSBnZXQgY29tcG9uZW50KCk6IGFueSB7XG4gICAgaWYgKHRoaXMuY29tcG9uZW50UmVmKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxhbnk+O1xuXG4gIHByaXZhdGUgZ2V0IHByb2plY3RhYmxlTm9kZXMoKTogYW55W11bXSB7XG4gICAgcmV0dXJuIFsgdGhpcy50ZW1wbGF0ZVJlZi5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5jb250ZXh0KS5yb290Tm9kZXMgXTtcbiAgfVxuXG4gIHByaXZhdGUgZW1iZWRkZWRWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8TGF6eUNvbnRleHQ+ID1cbiAgICB0aGlzLnRlbXBsYXRlUmVmLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLmNvbnRleHQpO1xuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb25MaWtlO1xuICBwcml2YXRlIG5nTW9kdWxlUmVmOiBOZ01vZHVsZVJlZjxhbnk+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPExhenlDb250ZXh0PixcbiAgICBwcml2YXRlIHZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBsb2FkZXI6IE5nTW9kdWxlRmFjdG9yeUxvYWRlcixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxuICApIHt9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICgnbGF6eScgaW4gY2hhbmdlcykge1xuICAgICAgdGhpcy5vbkxhenlEaWRDaGFuZ2VkKHRoaXMubGF6eSwgY2hhbmdlcy5sYXp5LnByZXZpb3VzVmFsdWUpO1xuICAgIH1cblxuICAgIGlmICgnbGF6eUxvYWRDaGlsZHJlbicgaW4gY2hhbmdlcykge1xuICAgICAgdGhpcy5vbkxhenlEaWRDaGFuZ2VkKHRoaXMubGF6eUxvYWRDaGlsZHJlbiwgY2hhbmdlcy5sYXp5TG9hZENoaWxkcmVuLnByZXZpb3VzVmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGlzcG9zZSgpO1xuXG4gICAgaWYgKHRoaXMuZW1iZWRkZWRWaWV3UmVmKSB7XG4gICAgICB0aGlzLmVtYmVkZGVkVmlld1JlZi5kZXN0cm95KCk7XG4gICAgICB0aGlzLmVtYmVkZGVkVmlld1JlZiA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbkxhenlEaWRDaGFuZ2VkKGN1cnJlbnQ6IHN0cmluZywgcHJldmlvdXM6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghdGhpcy5uZ01vZHVsZVJlZikge1xuICAgICAgcmV0dXJuIGN1cnJlbnQgJiYgdGhpcy5sb2FkQW5kUmVuZGVyKGN1cnJlbnQpO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50ICE9PSBwcmV2aW91cykge1xuICAgICAgdGhpcy5kaXNwb3NlKCk7XG4gICAgICByZXR1cm4gdGhpcy5vbkxhenlEaWRDaGFuZ2VkKGN1cnJlbnQsIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9hZEFuZFJlbmRlcihwYXRoOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMubG9hZChwYXRoKS5waXBlKFxuICAgICAgdGFwKChuZ01vZHVsZUZhY3Rvcnk6IE5nTW9kdWxlRmFjdG9yeTxhbnk+KSA9PiB7XG4gICAgICAgIHRoaXMubmdNb2R1bGVSZWYgPSBuZ01vZHVsZUZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xuXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudDogVHlwZTxhbnk+ID0gdGhpcy5uZ01vZHVsZVJlZi5pbmplY3Rvci5nZXQoTEFaWV9DT01QT05FTlRfVE9LRU4pO1xuICAgICAgICBjb25zdCBjb21wb25lbnRGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5PGFueT4gPVxuICAgICAgICAgIHRoaXMubmdNb2R1bGVSZWYuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCk7XG5cbiAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSB0aGlzLnZpZXdDb250YWluZXIuY3JlYXRlQ29tcG9uZW50KFxuICAgICAgICAgIGNvbXBvbmVudEZhY3RvcnksIHRoaXMudmlld0NvbnRhaW5lci5sZW5ndGgsIHRoaXMuaW5qZWN0b3IsXG4gICAgICAgICAgdGhpcy5wcm9qZWN0YWJsZU5vZGVzLCB0aGlzLm5nTW9kdWxlUmVmXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMub25BY3RpdmF0ZSh0aGlzLmNvbXBvbmVudCkpXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZChwYXRoOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE5nTW9kdWxlRmFjdG9yeTxhbnk+PiB7XG4gICAgY29uc3QgcGF0aFByb2R1Y3Rpb24gPSBwYXRoLnNwbGl0KCcjJykuam9pbignLnRzIycpO1xuICAgIHJldHVybiBmcm9tKHRoaXMubG9hZGVyLmxvYWQocGF0aFByb2R1Y3Rpb24pKS5waXBlKFxuICAgICAgY2F0Y2hFcnJvcigoKSA9PiBmcm9tKHRoaXMubG9hZGVyLmxvYWQocGF0aCkpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIG9uQWN0aXZhdGUoY29tcG9uZW50OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2YXRlLmVtaXQoY29tcG9uZW50KTtcbiAgICBpZiAoaXNGdW5jdGlvbih0aGlzLmxhenlBY3RpdmF0ZSkpIHtcbiAgICAgIHRoaXMubGF6eUFjdGl2YXRlKGNvbXBvbmVudCk7XG4gICAgfVxuICAgIHRoaXMuY29udGV4dC4kaW1wbGljaXQgPSBjb21wb25lbnQ7XG4gICAgdGhpcy5lbWJlZGRlZFZpZXdSZWYubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBwcml2YXRlIG9uRGVhY3RpdmF0ZShjb21wb25lbnQ6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuZGVhY3RpdmF0ZS5lbWl0KGNvbXBvbmVudCk7XG4gICAgaWYgKGlzRnVuY3Rpb24odGhpcy5sYXp5RGVhY3RpdmF0ZSkpIHtcbiAgICAgIHRoaXMubGF6eURlYWN0aXZhdGUoY29tcG9uZW50KTtcbiAgICB9XG4gICAgdGhpcy5jb250ZXh0LiRpbXBsaWNpdCA9IG51bGw7XG4gICAgdGhpcy5lbWJlZGRlZFZpZXdSZWYubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBwcml2YXRlIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29tcG9uZW50UmVmKSB7XG4gICAgICBjb25zdCBjID0gdGhpcy5jb21wb25lbnQ7XG4gICAgICB0aGlzLmNvbXBvbmVudFJlZi5kZXN0cm95KCk7XG4gICAgICB0aGlzLmNvbXBvbmVudFJlZiA9IG51bGw7XG4gICAgICB0aGlzLm9uRGVhY3RpdmF0ZShjKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5uZ01vZHVsZVJlZikge1xuICAgICAgdGhpcy5uZ01vZHVsZVJlZi5kZXN0cm95KCk7XG4gICAgICB0aGlzLm5nTW9kdWxlUmVmID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgfVxuICB9XG5cbn1cblxuZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZTogYW55KTogdmFsdWUgaXMgRnVuY3Rpb24ge1xuICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nO1xufVxuIl19